-- =============================================
-- INVENTORY MODULE MIGRATION
-- Support: FnB, Pharmacy, Retail
-- =============================================

-- 1. ALTER inventory table - tambah field baru
ALTER TABLE "public"."inventory"
ADD COLUMN IF NOT EXISTS "sku" VARCHAR(100) NULL,
ADD COLUMN IF NOT EXISTS "min_stock" NUMERIC NOT NULL DEFAULT 0,
ADD COLUMN IF NOT EXISTS "business_type" VARCHAR(20) NOT NULL DEFAULT 'fnb',
ADD COLUMN IF NOT EXISTS "supplier_id" INTEGER NULL,
ADD COLUMN IF NOT EXISTS "days_cover" NUMERIC NULL DEFAULT 0,
ADD COLUMN IF NOT EXISTS "source" VARCHAR(50) NULL,
ADD COLUMN IF NOT EXISTS "batch_no" VARCHAR(100) NULL,
ADD COLUMN IF NOT EXISTS "expiry_date" DATE NULL,
ADD COLUMN IF NOT EXISTS "variant" VARCHAR(255) NULL,
ADD COLUMN IF NOT EXISTS "barcode" VARCHAR(100) NULL,
ADD COLUMN IF NOT EXISTS "last_restock_date" TIMESTAMP NULL,
ADD COLUMN IF NOT EXISTS "avg_daily_usage" NUMERIC NULL DEFAULT 0;

-- 2. Add foreign key untuk supplier
ALTER TABLE "public"."inventory"
ADD CONSTRAINT "inventory_supplier_id_fkey"
FOREIGN KEY ("supplier_id") REFERENCES "public"."suppliers" ("id")
ON DELETE SET NULL ON UPDATE NO ACTION;

-- 3. Add indexes baru
CREATE INDEX IF NOT EXISTS "idx_inventory_business_type" ON "public"."inventory" ("business_type" ASC);
CREATE INDEX IF NOT EXISTS "idx_inventory_supplier" ON "public"."inventory" ("supplier_id" ASC);
CREATE INDEX IF NOT EXISTS "idx_inventory_sku" ON "public"."inventory" ("sku" ASC);
CREATE INDEX IF NOT EXISTS "idx_inventory_barcode" ON "public"."inventory" ("barcode" ASC);
CREATE INDEX IF NOT EXISTS "idx_inventory_expiry" ON "public"."inventory" ("expiry_date" ASC);

-- 4. Create purchase_orders table
CREATE TABLE IF NOT EXISTS "public"."purchase_orders" (
  "id" SERIAL,
  "outlet_id" INTEGER NOT NULL,
  "po_number" VARCHAR(100) NOT NULL,
  "supplier_id" INTEGER NULL,
  "status" VARCHAR(20) NOT NULL DEFAULT 'draft',
  "order_date" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "expected_date" DATE NULL,
  "received_date" TIMESTAMP NULL,
  "subtotal" NUMERIC NOT NULL DEFAULT 0,
  "tax_amount" NUMERIC NOT NULL DEFAULT 0,
  "discount_amount" NUMERIC NOT NULL DEFAULT 0,
  "total" NUMERIC NOT NULL DEFAULT 0,
  "notes" TEXT NULL,
  "created_by" INTEGER NOT NULL,
  "approved_by" INTEGER NULL,
  "approved_at" TIMESTAMP NULL,
  "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "purchase_orders_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "purchase_orders_po_number_key" UNIQUE ("po_number")
);

-- 5. Create purchase_order_items table
CREATE TABLE IF NOT EXISTS "public"."purchase_order_items" (
  "id" SERIAL,
  "po_id" INTEGER NOT NULL,
  "inventory_id" INTEGER NOT NULL,
  "quantity" NUMERIC NOT NULL,
  "unit" VARCHAR(50) NOT NULL,
  "unit_price" NUMERIC NOT NULL DEFAULT 0,
  "subtotal" NUMERIC NOT NULL DEFAULT 0,
  "received_qty" NUMERIC NOT NULL DEFAULT 0,
  "notes" TEXT NULL,
  "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "purchase_order_items_pkey" PRIMARY KEY ("id")
);

-- 6. Create inventory_settings table
CREATE TABLE IF NOT EXISTS "public"."inventory_settings" (
  "id" SERIAL,
  "outlet_id" INTEGER NOT NULL,
  "business_type" VARCHAR(20) NOT NULL DEFAULT 'fnb',
  "low_stock_threshold_days" INTEGER NOT NULL DEFAULT 3,
  "auto_reorder_enabled" BOOLEAN NOT NULL DEFAULT false,
  "reorder_lead_days" INTEGER NOT NULL DEFAULT 2,
  "track_expiry" BOOLEAN NOT NULL DEFAULT false,
  "expiry_warning_days" INTEGER NOT NULL DEFAULT 30,
  "track_batch" BOOLEAN NOT NULL DEFAULT false,
  "settings" JSONB NULL DEFAULT '{}'::jsonb,
  "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "inventory_settings_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "inventory_settings_outlet_unique" UNIQUE ("outlet_id")
);

-- 7. Create inventory_alerts table
CREATE TABLE IF NOT EXISTS "public"."inventory_alerts" (
  "id" SERIAL,
  "outlet_id" INTEGER NOT NULL,
  "inventory_id" INTEGER NOT NULL,
  "alert_type" VARCHAR(50) NOT NULL,
  "severity" VARCHAR(20) NOT NULL DEFAULT 'warning',
  "message" TEXT NOT NULL,
  "is_read" BOOLEAN NOT NULL DEFAULT false,
  "is_resolved" BOOLEAN NOT NULL DEFAULT false,
  "resolved_at" TIMESTAMP NULL,
  "resolved_by" INTEGER NULL,
  "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "inventory_alerts_pkey" PRIMARY KEY ("id")
);

-- 8. Create inventory_forecast table
CREATE TABLE IF NOT EXISTS "public"."inventory_forecast" (
  "id" SERIAL,
  "outlet_id" INTEGER NOT NULL,
  "inventory_id" INTEGER NULL,
  "forecast_date" DATE NOT NULL,
  "predicted_usage" NUMERIC NOT NULL DEFAULT 0,
  "actual_usage" NUMERIC NULL,
  "confidence_level" NUMERIC NULL,
  "factors" JSONB NULL DEFAULT '{}'::jsonb,
  "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "inventory_forecast_pkey" PRIMARY KEY ("id")
);

-- 9. Add foreign keys untuk tables baru
ALTER TABLE "public"."purchase_orders"
ADD CONSTRAINT "purchase_orders_outlet_fkey" FOREIGN KEY ("outlet_id") REFERENCES "public"."outlets" ("id") ON DELETE CASCADE ON UPDATE NO ACTION,
ADD CONSTRAINT "purchase_orders_supplier_fkey" FOREIGN KEY ("supplier_id") REFERENCES "public"."suppliers" ("id") ON DELETE SET NULL ON UPDATE NO ACTION,
ADD CONSTRAINT "purchase_orders_created_by_fkey" FOREIGN KEY ("created_by") REFERENCES "public"."users" ("id") ON DELETE NO ACTION ON UPDATE NO ACTION,
ADD CONSTRAINT "purchase_orders_approved_by_fkey" FOREIGN KEY ("approved_by") REFERENCES "public"."users" ("id") ON DELETE SET NULL ON UPDATE NO ACTION;

ALTER TABLE "public"."purchase_order_items"
ADD CONSTRAINT "po_items_po_fkey" FOREIGN KEY ("po_id") REFERENCES "public"."purchase_orders" ("id") ON DELETE CASCADE ON UPDATE NO ACTION,
ADD CONSTRAINT "po_items_inventory_fkey" FOREIGN KEY ("inventory_id") REFERENCES "public"."inventory" ("id") ON DELETE CASCADE ON UPDATE NO ACTION;

ALTER TABLE "public"."inventory_settings"
ADD CONSTRAINT "inventory_settings_outlet_fkey" FOREIGN KEY ("outlet_id") REFERENCES "public"."outlets" ("id") ON DELETE CASCADE ON UPDATE NO ACTION;

ALTER TABLE "public"."inventory_alerts"
ADD CONSTRAINT "inventory_alerts_outlet_fkey" FOREIGN KEY ("outlet_id") REFERENCES "public"."outlets" ("id") ON DELETE CASCADE ON UPDATE NO ACTION,
ADD CONSTRAINT "inventory_alerts_inventory_fkey" FOREIGN KEY ("inventory_id") REFERENCES "public"."inventory" ("id") ON DELETE CASCADE ON UPDATE NO ACTION,
ADD CONSTRAINT "inventory_alerts_resolved_by_fkey" FOREIGN KEY ("resolved_by") REFERENCES "public"."users" ("id") ON DELETE SET NULL ON UPDATE NO ACTION;

ALTER TABLE "public"."inventory_forecast"
ADD CONSTRAINT "inventory_forecast_outlet_fkey" FOREIGN KEY ("outlet_id") REFERENCES "public"."outlets" ("id") ON DELETE CASCADE ON UPDATE NO ACTION,
ADD CONSTRAINT "inventory_forecast_inventory_fkey" FOREIGN KEY ("inventory_id") REFERENCES "public"."inventory" ("id") ON DELETE CASCADE ON UPDATE NO ACTION;

-- 10. Add indexes untuk tables baru
CREATE INDEX "idx_po_outlet" ON "public"."purchase_orders" ("outlet_id" ASC);
CREATE INDEX "idx_po_supplier" ON "public"."purchase_orders" ("supplier_id" ASC);
CREATE INDEX "idx_po_status" ON "public"."purchase_orders" ("status" ASC);
CREATE INDEX "idx_po_date" ON "public"."purchase_orders" ("order_date" ASC);

CREATE INDEX "idx_po_items_po" ON "public"."purchase_order_items" ("po_id" ASC);
CREATE INDEX "idx_po_items_inventory" ON "public"."purchase_order_items" ("inventory_id" ASC);

CREATE INDEX "idx_inv_alerts_outlet" ON "public"."inventory_alerts" ("outlet_id" ASC);
CREATE INDEX "idx_inv_alerts_inventory" ON "public"."inventory_alerts" ("inventory_id" ASC);
CREATE INDEX "idx_inv_alerts_type" ON "public"."inventory_alerts" ("alert_type" ASC);
CREATE INDEX "idx_inv_alerts_resolved" ON "public"."inventory_alerts" ("is_resolved" ASC);

CREATE INDEX "idx_inv_forecast_outlet" ON "public"."inventory_forecast" ("outlet_id" ASC);
CREATE INDEX "idx_inv_forecast_date" ON "public"."inventory_forecast" ("forecast_date" ASC);

-- 11. Add check constraint untuk business_type
ALTER TABLE "public"."inventory"
ADD CONSTRAINT "inventory_business_type_check"
CHECK (business_type IN ('fnb', 'pharmacy', 'retail'));

-- 12. Add check constraint untuk PO status
ALTER TABLE "public"."purchase_orders"
ADD CONSTRAINT "po_status_check"
CHECK (status IN ('draft', 'pending', 'approved', 'ordered', 'partial', 'received', 'cancelled'));

-- 13. Add check constraint untuk alert severity
ALTER TABLE "public"."inventory_alerts"
ADD CONSTRAINT "alert_severity_check"
CHECK (severity IN ('info', 'warning', 'critical'));

-- 14. Create view untuk low stock items
CREATE OR REPLACE VIEW "public"."v_inventory_low_stock" AS
SELECT
  i.id,
  i.outlet_id,
  i.name,
  i.sku,
  i.category,
  i.business_type,
  i.current_stock,
  i.min_stock,
  i.stock_alert,
  i.unit,
  i.days_cover,
  i.expiry_date,
  s.name as supplier_name,
  CASE
    WHEN i.current_stock <= 0 THEN 'Habis'
    WHEN i.current_stock <= i.min_stock THEN 'Menipis'
    ELSE 'Aman'
  END as status
FROM inventory i
LEFT JOIN suppliers s ON s.id = i.supplier_id
WHERE i.is_active = true
  AND (i.current_stock <= i.min_stock OR (i.alert = true AND i.current_stock <= i.stock_alert));

-- 15. Create view untuk expiring items (Pharmacy)
CREATE OR REPLACE VIEW "public"."v_inventory_expiring" AS
SELECT
  i.id,
  i.outlet_id,
  i.name,
  i.sku,
  i.batch_no,
  i.expiry_date,
  i.current_stock,
  i.unit,
  (i.expiry_date - CURRENT_DATE) as days_until_expiry,
  CASE
    WHEN i.expiry_date < CURRENT_DATE THEN 'Expired'
    WHEN (i.expiry_date - CURRENT_DATE) <= 30 THEN 'Expiring Soon'
    WHEN (i.expiry_date - CURRENT_DATE) <= 90 THEN 'Warning'
    ELSE 'OK'
  END as expiry_status
FROM inventory i
WHERE i.is_active = true
  AND i.business_type = 'pharmacy'
  AND i.expiry_date IS NOT NULL
ORDER BY i.expiry_date ASC;

-- 16. Update trigger untuk updated_at
CREATE OR REPLACE TRIGGER "update_inventory_updated_at"
BEFORE UPDATE ON "public"."inventory"
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE OR REPLACE TRIGGER "update_purchase_orders_updated_at"
BEFORE UPDATE ON "public"."purchase_orders"
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE OR REPLACE TRIGGER "update_inventory_settings_updated_at"
BEFORE UPDATE ON "public"."inventory_settings"
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
