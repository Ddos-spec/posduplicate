-- =============================================================
-- QUERY OPERASIONAL & LAPORAN (POSDuplicate) - 2026-01-21
-- GANTI nilai tenant_id/outlet_id/tanggal sesuai kebutuhan.
-- =============================================================

-- 1) POS: Ringkasan penjualan harian per outlet
SELECT
  o.id AS outlet_id,
  o.name AS outlet_name,
  DATE(t.created_at) AS sale_date,
  COUNT(*) AS total_tx,
  SUM(t.subtotal) AS subtotal,
  SUM(t.discount_amount) AS total_discount,
  SUM(t.tax_amount) AS total_tax,
  SUM(t.service_charge) AS total_service_charge,
  SUM(t.total) AS grand_total
FROM public.transactions t
JOIN public.outlets o ON o.id = t.outlet_id
WHERE t.status = 'completed'
  AND o.tenant_id = 1
  AND t.created_at >= '2026-01-01'
  AND t.created_at <  '2026-02-01'
GROUP BY o.id, o.name, DATE(t.created_at)
ORDER BY sale_date, outlet_name;

-- 2) POS: Top 20 item terlaris (qty)
SELECT
  i.id,
  i.name,
  SUM(ti.quantity) AS qty_sold,
  SUM(ti.subtotal) AS revenue
FROM public.transaction_items ti
JOIN public.transactions t ON t.id = ti.transaction_id
JOIN public.items i ON i.id = ti.item_id
JOIN public.outlets o ON o.id = t.outlet_id
WHERE t.status = 'completed'
  AND o.tenant_id = 1
  AND t.created_at >= '2026-01-01'
  AND t.created_at <  '2026-02-01'
GROUP BY i.id, i.name
ORDER BY qty_sold DESC
LIMIT 20;

-- 3) POS: Breakdown metode pembayaran
SELECT
  p.method,
  COUNT(*) AS total_payments,
  SUM(p.amount) AS total_amount
FROM public.payments p
JOIN public.transactions t ON t.id = p.transaction_id
JOIN public.outlets o ON o.id = t.outlet_id
WHERE t.status = 'completed'
  AND o.tenant_id = 1
  AND t.created_at >= '2026-01-01'
  AND t.created_at <  '2026-02-01'
GROUP BY p.method
ORDER BY total_amount DESC;

-- 4) POS: Transaksi pending/held
SELECT
  t.id,
  t.transaction_number,
  t.order_type,
  t.status,
  t.created_at,
  o.name AS outlet_name,
  u.name AS cashier
FROM public.transactions t
JOIN public.outlets o ON o.id = t.outlet_id
LEFT JOIN public.users u ON u.id = t.cashier_id
WHERE t.status IN ('pending')
  AND o.tenant_id = 1
ORDER BY t.created_at DESC;

-- 5) Inventory: Low stock (view)
SELECT *
FROM public.v_inventory_low_stock
WHERE outlet_id = 1
ORDER BY current_stock ASC;

-- 6) Inventory: Stock movements per item/outlet
SELECT
  sm.id,
  sm.created_at,
  sm.type,
  sm.quantity,
  sm.stock_before,
  sm.stock_after,
  COALESCE(i.name, inv.name, ing.name) AS item_name,
  o.name AS outlet_name,
  u.name AS user_name
FROM public.stock_movements sm
LEFT JOIN public.items i ON i.id = sm.item_id
LEFT JOIN public.inventory inv ON inv.id = sm.inventory_id
LEFT JOIN public.ingredients ing ON ing.id = sm.ingredient_id
JOIN public.outlets o ON o.id = sm.outlet_id
LEFT JOIN public.users u ON u.id = sm.user_id
WHERE o.tenant_id = 1
  AND sm.created_at >= '2026-01-01'
  AND sm.created_at <  '2026-02-01'
ORDER BY sm.created_at DESC;

-- 7) Inventory: Nilai persediaan per outlet
SELECT
  o.id AS outlet_id,
  o.name AS outlet_name,
  SUM(inv.current_stock * inv.cost_amount) AS inventory_value
FROM public.inventory inv
JOIN public.outlets o ON o.id = inv.outlet_id
WHERE o.tenant_id = 1
GROUP BY o.id, o.name
ORDER BY inventory_value DESC;

-- 8) Purchase Orders: Summary per status
SELECT
  po.status,
  COUNT(*) AS total_po,
  SUM(po.total) AS total_amount
FROM public.purchase_orders po
JOIN public.outlets o ON o.id = po.outlet_id
WHERE o.tenant_id = 1
GROUP BY po.status
ORDER BY total_po DESC;

-- 9) Accounting: Trial Balance
SELECT *
FROM accounting.v_trial_balance
WHERE tenant_id = 1
ORDER BY account_code ASC;

-- 10) Accounting: Income Statement (P&L) periode
SELECT
  coa.account_type,
  coa.account_code,
  coa.account_name,
  SUM(gl.debit_amount) AS total_debit,
  SUM(gl.credit_amount) AS total_credit
FROM accounting.general_ledger gl
JOIN accounting.chart_of_accounts coa ON coa.id = gl.account_id
WHERE gl.tenant_id = 1
  AND gl.transaction_date >= '2026-01-01'
  AND gl.transaction_date <  '2026-02-01'
  AND coa.account_type IN ('REVENUE','EXPENSE','COGS')
GROUP BY coa.account_type, coa.account_code, coa.account_name
ORDER BY coa.account_code ASC;

-- 11) Accounting: Balance Sheet (as of date)
SELECT
  coa.account_type,
  coa.account_code,
  coa.account_name,
  coa.normal_balance,
  SUM(gl.debit_amount) AS total_debit,
  SUM(gl.credit_amount) AS total_credit
FROM accounting.general_ledger gl
JOIN accounting.chart_of_accounts coa ON coa.id = gl.account_id
WHERE gl.tenant_id = 1
  AND gl.transaction_date <= '2026-01-31'
  AND coa.account_type IN ('ASSET','CASH_BANK','INVENTORY','FIXED_ASSET','ACCOUNT_RECEIVABLE','LIABILITY','ACCOUNT_PAYABLE','TAX_PAYABLE','EQUITY','RETAINED_EARNINGS')
GROUP BY coa.account_type, coa.account_code, coa.account_name, coa.normal_balance
ORDER BY coa.account_code ASC;

-- 12) Accounting: AR Aging
SELECT *
FROM accounting.v_ar_aging
WHERE tenant_id = 1
ORDER BY days_overdue DESC;

-- 13) Accounting: AP Aging
SELECT *
FROM accounting.v_ap_aging
WHERE tenant_id = 1
ORDER BY days_overdue DESC;

-- 14) Payroll: Summary per period
SELECT
  pp.id AS period_id,
  pp.period_start,
  pp.period_end,
  pp.status,
  COUNT(pd.id) AS total_employees,
  SUM(pd.gross_salary) AS total_gross,
  SUM(pd.total_deductions) AS total_deductions,
  SUM(pd.net_salary) AS total_net
FROM accounting.payroll_periods pp
LEFT JOIN accounting.payroll_details pd ON pd.period_id = pp.id
WHERE pp.tenant_id = 1
GROUP BY pp.id, pp.period_start, pp.period_end, pp.status
ORDER BY pp.period_start DESC;

-- 15) Medsos: Post terjadwal 7 hari ke depan
SELECT
  sp.id,
  sp.platform,
  sp.status,
  sp.scheduled_at,
  sa.account_name
FROM public.social_posts sp
LEFT JOIN public.social_accounts sa ON sa.id = sp.account_id
WHERE sp.tenant_id = 1
  AND sp.status = 'scheduled'
  AND sp.scheduled_at >= CURRENT_DATE
  AND sp.scheduled_at < CURRENT_DATE + INTERVAL '7 days'
ORDER BY sp.scheduled_at ASC;

-- 16) Medsos: Performa post published
SELECT
  sp.id,
  sp.platform,
  sp.published_at,
  sa.account_name,
  an.impressions,
  an.reach,
  an.likes,
  an.comments,
  an.shares,
  an.saves,
  an.engagement_rate
FROM public.social_posts sp
JOIN public.social_analytics an ON an.post_id = sp.id
LEFT JOIN public.social_accounts sa ON sa.id = sp.account_id
WHERE sp.tenant_id = 1
  AND sp.status = 'published'
ORDER BY sp.published_at DESC;

-- 17) Medsos: Token akan kadaluarsa (7 hari)
SELECT
  sa.id,
  sa.platform,
  sa.account_name,
  sa.token_expires
FROM public.social_accounts sa
WHERE sa.tenant_id = 1
  AND sa.token_expires IS NOT NULL
  AND sa.token_expires < NOW() + INTERVAL '7 days'
ORDER BY sa.token_expires ASC;

-- 18) User: Active users per outlet
SELECT
  o.id AS outlet_id,
  o.name AS outlet_name,
  COUNT(u.id) AS active_users
FROM public.users u
JOIN public.outlets o ON o.id = u.outlet_id
WHERE u.is_active = true
  AND o.tenant_id = 1
GROUP BY o.id, o.name
ORDER BY active_users DESC;
