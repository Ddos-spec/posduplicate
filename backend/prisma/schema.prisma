generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(50)
  permissions Json?     @default("{}")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  users       User[]

  @@map("roles")
}

model Tenant {
  id                    Int       @id @default(autoincrement())
  businessName          String    @map("business_name") @db.VarChar(255)
  ownerName             String    @map("owner_name") @db.VarChar(255)
  email                 String    @unique @db.VarChar(255)
  phone                 String?   @db.VarChar(50)
  address               String?
  subscriptionPlan      String?   @default("basic") @map("subscription_plan") @db.VarChar(50)
  subscriptionStatus    String?   @default("trial") @map("subscription_status") @db.VarChar(50)
  subscriptionStartsAt  DateTime? @map("subscription_starts_at") @db.Timestamp(6)
  subscriptionExpiresAt DateTime? @map("subscription_expires_at") @db.Timestamp(6)
  maxOutlets            Int?      @default(1) @map("max_outlets")
  maxUsers              Int?      @default(5) @map("max_users")
  billingEmail          String?   @map("billing_email") @db.VarChar(255)
  paymentMethod         String?   @map("payment_method") @db.VarChar(50)
  lastPaymentAt         DateTime? @map("last_payment_at") @db.Timestamp(6)
  nextBillingDate       DateTime? @map("next_billing_date") @db.Date
  settings              Json?     @default("{}")
  features              Json?     @default("{}")
  isActive              Boolean?  @default(true) @map("is_active")
  createdAt             DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt             DateTime? @map("deleted_at") @db.Timestamp(6)
  outlets               Outlet[]
  users                 User[]
  apiKeys               ApiKey[]

  @@index([subscriptionStatus], map: "idx_tenants_status")
  @@index([isActive], map: "idx_tenants_active")
  @@index([email], map: "idx_tenants_email")
  @@map("tenants")
}

model Outlet {
  id           Int           @id @default(autoincrement())
  tenantId     Int?          @map("tenant_id")
  name         String        @db.VarChar(255)
  address      String?
  phone        String?       @db.VarChar(50)
  email        String?       @db.VarChar(255)
  npwp         String?       @db.VarChar(50)
  settings     Json?         @default("{}")
  isActive     Boolean?      @default(true) @map("is_active")
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  categories   categories[]
  customers    customers[]
  ingredients  ingredients[]
  items        items[]
  modifiers    modifiers[]
  tenants      Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  promotions   promotions[]
  tables       tables[]
  transactions Transaction[]
  users        User[]

  @@index([tenantId], map: "idx_outlets_tenant")
  @@map("outlets")
}

model User {
  id            Int            @id @default(autoincrement())
  tenantId      Int?           @map("tenant_id")
  email         String         @unique @db.VarChar(255)
  passwordHash  String         @map("password_hash") @db.VarChar(255)
  name          String         @db.VarChar(255)
  roleId        Int            @map("role_id")
  outletId      Int?           @map("outlet_id")
  isActive      Boolean?       @default(true) @map("is_active")
  lastLogin     DateTime?      @map("last_login") @db.Timestamp(6)
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  transactions  Transaction[]
  cashierShifts CashierShift[]
  activityLogs  ActivityLog[]
  outlets       Outlet?        @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles         Role           @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants       Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId], map: "idx_users_tenant")
  @@index([email], map: "idx_users_email")
  @@index([outletId], map: "idx_users_outlet")
  @@map("users")
}

model Transaction {
  id                 Int               @id @default(autoincrement())
  transaction_number String            @unique @db.VarChar(100)
  order_type         String            @db.VarChar(50)
  table_id           Int?
  customer_name      String?           @db.VarChar(255)
  customer_phone     String?           @db.VarChar(50)
  subtotal           Decimal?          @default(0) @db.Decimal(12, 2)
  discountAmount     Decimal?          @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxAmount          Decimal?          @default(0) @map("tax_amount") @db.Decimal(12, 2)
  service_charge     Decimal?          @default(0) @db.Decimal(12, 2)
  total              Decimal?          @default(0) @db.Decimal(12, 2)
  status             String?           @default("pending") @db.VarChar(50)
  notes              String?
  outletId           Int?              @map("outlet_id")
  cashier_id         Int?
  createdAt          DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updated_at         DateTime?         @default(now()) @db.Timestamp(6)
  completed_at       DateTime?         @db.Timestamp(6)
  promotion_id       Int?
  discount_usage     discount_usage[]
  payments           payments[]
  transaction_items  TransactionItem[]
  users              User?             @relation(fields: [cashier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets            Outlet?           @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  promotions         promotions?       @relation(fields: [promotion_id], references: [id], onUpdate: NoAction)
  tables             tables?           @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([outletId], map: "idx_transactions_outlet")
  @@index([cashier_id], map: "idx_transactions_cashier")
  @@index([createdAt], map: "idx_transactions_created")
  @@index([transaction_number], map: "idx_transactions_number")
  @@index([status], map: "idx_transactions_status")
  @@map("transactions")
}

model TransactionItem {
  id                    Int                     @id @default(autoincrement())
  transactionId         Int                     @map("transaction_id")
  item_id               Int
  variant_id            Int?
  item_name             String                  @db.VarChar(255)
  quantity              Decimal                 @db.Decimal(12, 2)
  unit_price            Decimal                 @db.Decimal(12, 2)
  subtotal              Decimal                 @db.Decimal(12, 2)
  discount_amount       Decimal?                @default(0) @db.Decimal(12, 2)
  notes                 String?
  createdAt             DateTime?               @default(now()) @map("created_at") @db.Timestamp(6)
  items                 items                   @relation(fields: [item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions          Transaction             @relation(fields: [transactionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  variants              variants?               @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_modifiers transaction_modifiers[]

  @@index([transactionId], map: "idx_transaction_items_transaction")
  @@map("transaction_items")
}

model categories {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(255)
  type        String?       @default("item") @db.VarChar(50)
  outletId    Int?          @map("outlet_id")
  isActive    Boolean?      @default(true) @map("is_active")
  createdAt   DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime?     @default(now()) @map("updated_at") @db.Timestamp(6)
  outlets     Outlet?       @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ingredients ingredients[]
  items       items[]
}

model recipes {
  id            Int         @id @default(autoincrement())
  item_id       Int
  ingredient_id Int
  quantity      Decimal     @db.Decimal(12, 2)
  unit          String?     @db.VarChar(50)
  items         items       @relation(fields: [item_id], references: [id], onDelete: Cascade)
  ingredients   ingredients @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)

  @@map("recipes")
}

model customers {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(255)
  phone         String?   @db.VarChar(50)
  email         String?   @db.VarChar(255)
  address       String?
  date_of_birth DateTime? @db.Date
  outlet_id     Int?
  total_spent   Decimal?  @default(0) @db.Decimal(12, 2)
  total_visits  Int?      @default(0)
  last_visit    DateTime? @db.Timestamp(6)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  outlets       Outlet?   @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email], map: "idx_customers_email")
  @@index([outlet_id], map: "idx_customers_outlet")
  @@index([phone], map: "idx_customers_phone")
}


model ingredients {
  id            Int         @id @default(autoincrement())
  name          String      @db.VarChar(255)
  category_id   Int?
  unit          String      @db.VarChar(50)
  stock         Decimal?    @default(0) @db.Decimal(12, 2)
  min_stock     Decimal?    @default(0) @db.Decimal(12, 2)
  cost_per_unit Decimal?    @default(0) @db.Decimal(12, 2)
  outlet_id     Int?
  is_active     Boolean?    @default(true)
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  updated_at    DateTime?   @default(now()) @db.Timestamp(6)
  categories    categories? @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets       Outlet?     @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipes       recipes[]

  @@index([outlet_id], map: "idx_ingredients_outlet")
}

model item_modifiers {
  item_id     Int
  modifier_id Int
  items       items     @relation(fields: [item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifiers   modifiers @relation(fields: [modifier_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([item_id, modifier_id])
}

model items {
  id                Int               @id @default(autoincrement())
  name              String            @db.VarChar(255)
  categoryId        Int?              @map("category_id")
  price             Decimal           @default(0) @db.Decimal(12, 2)
  priceGofood       Decimal?          @map("price_gofood") @db.Decimal(12, 2)
  priceGrabfood     Decimal?          @map("price_grabfood") @db.Decimal(12, 2)
  priceShopeefood   Decimal?          @map("price_shopeefood") @db.Decimal(12, 2)
  cost              Decimal?          @default(0) @db.Decimal(12, 2)
  image             String?           @db.VarChar(500)
  description       String?
  sku               String?           @db.VarChar(100)
  stock             Decimal?          @default(0) @db.Decimal(12, 2)
  trackStock        Boolean?          @default(false) @map("track_stock")
  minStock          Decimal?          @default(0) @map("min_stock") @db.Decimal(12, 2)
  outletId          Int?              @map("outlet_id")
  isActive          Boolean?          @default(true) @map("is_active")
  createdAt         DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime?         @default(now()) @map("updated_at") @db.Timestamp(6)
  item_modifiers    item_modifiers[]
  categories        categories?       @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets           Outlet?           @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_items TransactionItem[]
  variants          variants[]
  recipes           recipes[]

  @@index([isActive], map: "idx_items_active")
  @@index([categoryId], map: "idx_items_category")
  @@index([outletId], map: "idx_items_outlet")
}

model modifiers {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @db.VarChar(255)
  price                 Decimal?                @default(0) @db.Decimal(12, 2)
  outlet_id             Int?
  is_active             Boolean?                @default(true)
  created_at            DateTime?               @default(now()) @db.Timestamp(6)
  updated_at            DateTime?               @default(now()) @db.Timestamp(6)
  item_modifiers        item_modifiers[]
  outlets               Outlet?                 @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_modifiers transaction_modifiers[]
}

model payments {
  id               Int         @id @default(autoincrement())
  transaction_id   Int
  method           String      @db.VarChar(50)
  amount           Decimal     @db.Decimal(12, 2)
  change_amount    Decimal?    @default(0) @db.Decimal(12, 2)
  reference_number String?     @db.VarChar(255)
  status           String?     @default("completed") @db.VarChar(50)
  created_at       DateTime?   @default(now()) @db.Timestamp(6)
  transactions     Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model tables {
  id           Int           @id @default(autoincrement())
  name         String        @db.VarChar(100)
  capacity     Int?          @default(4)
  status       String?       @default("available") @db.VarChar(50)
  outlet_id    Int?
  is_active    Boolean?      @default(true)
  created_at   DateTime?     @default(now()) @db.Timestamp(6)
  updated_at   DateTime?     @default(now()) @db.Timestamp(6)
  outlets      Outlet?       @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions Transaction[]
}

model transaction_modifiers {
  id                  Int             @id @default(autoincrement())
  transaction_item_id Int
  modifier_id         Int
  modifier_name       String          @db.VarChar(255)
  price               Decimal         @db.Decimal(12, 2)
  modifiers           modifiers       @relation(fields: [modifier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_items   TransactionItem @relation(fields: [transaction_item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model variants {
  id                Int               @id @default(autoincrement())
  item_id           Int
  name              String            @db.VarChar(255)
  price_adjust      Decimal?          @default(0) @db.Decimal(12, 2)
  sku               String?           @db.VarChar(100)
  stock             Decimal?          @default(0) @db.Decimal(12, 2)
  is_active         Boolean?          @default(true)
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  transaction_items TransactionItem[]
  items             items             @relation(fields: [item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model discount_usage {
  id              Int          @id @default(autoincrement())
  promotion_id    Int?
  transaction_id  Int?
  discount_amount Decimal      @db.Decimal(12, 2)
  created_at      DateTime?    @default(now()) @db.Timestamp(6)
  promotions      promotions?  @relation(fields: [promotion_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transactions    Transaction? @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([promotion_id], map: "idx_discount_usage_promotion")
  @@index([transaction_id], map: "idx_discount_usage_transaction")
}

model promotions {
  id             Int              @id @default(autoincrement())
  outlet_id      Int?
  name           String           @db.VarChar(255)
  description    String?
  discount_type  String           @db.VarChar(50)
  discount_value Decimal          @db.Decimal(12, 2)
  min_purchase   Decimal?         @default(0) @db.Decimal(12, 2)
  max_discount   Decimal?         @db.Decimal(12, 2)
  applicable_to  String?          @default("all") @db.VarChar(50)
  applicable_ids Json?            @db.Json
  start_date     DateTime?        @db.Timestamp(6)
  end_date       DateTime?        @db.Timestamp(6)
  usage_limit    Int?
  usage_count    Int?             @default(0)
  is_active      Boolean?         @default(true)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  updated_at     DateTime?        @default(now()) @db.Timestamp(6)
  discount_usage discount_usage[]
  outlets        Outlet?          @relation(fields: [outlet_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transactions   Transaction[]

  @@index([is_active], map: "idx_promotions_active")
  @@index([start_date, end_date], map: "idx_promotions_dates")
  @@index([outlet_id], map: "idx_promotions_outlet")
}

model CashierShift {
  id               Int           @id @default(autoincrement())
  shift_number     String        @unique @map("shift_number") @db.VarChar(100)
  user_id          Int           @map("user_id")
  outlet_id        Int           @map("outlet_id")
  started_at       DateTime      @map("started_at") @db.Timestamp(6)
  ended_at         DateTime?     @map("ended_at") @db.Timestamp(6)
  opening_cash     Decimal?      @default(0) @map("opening_cash") @db.Decimal(12, 2)
  closing_cash     Decimal?      @map("closing_cash") @db.Decimal(12, 2)
  expected_cash    Decimal?      @default(0) @map("expected_cash") @db.Decimal(12, 2)
  actual_cash      Decimal?      @map("actual_cash") @db.Decimal(12, 2)
  difference       Decimal?      @default(0) @map("difference") @db.Decimal(12, 2)
  total_sales      Decimal?      @default(0) @map("total_sales") @db.Decimal(12, 2)
  transaction_count Int?         @default(0) @map("transaction_count")
  status           String        @default("open") @db.VarChar(50)
  notes            String?
  created_at       DateTime?     @default(now()) @db.Timestamp(6)
  updated_at       DateTime?     @default(now()) @db.Timestamp(6)
  users            User          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id], map: "idx_cashier_shifts_user")
  @@index([outlet_id], map: "idx_cashier_shifts_outlet")
  @@index([started_at], map: "idx_cashier_shifts_started")
  @@index([status], map: "idx_cashier_shifts_status")
  @@map("cashier_shifts")
}

model ActivityLog {
  id          Int       @id @default(autoincrement())
  user_id     Int       @map("user_id")
  outlet_id   Int?      @map("outlet_id")
  action_type String    @map("action_type") @db.VarChar(100)
  entity_type String    @map("entity_type") @db.VarChar(100)
  entity_id   Int?      @map("entity_id")
  old_value   Json?     @map("old_value") @db.Json
  new_value   Json?     @map("new_value") @db.Json
  reason      String?
  created_at  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  users       User      @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id], map: "idx_activity_logs_user")
  @@index([outlet_id], map: "idx_activity_logs_outlet")
  @@index([action_type], map: "idx_activity_logs_action")
  @@index([created_at], map: "idx_activity_logs_created")
  @@map("activity_logs")
}

model ApiKey {
  id          Int       @id @default(autoincrement())
  tenant_id   Int       @map("tenant_id")
  key_name    String    @map("key_name") @db.VarChar(255)
  api_key     String    @unique @map("api_key") @db.VarChar(255)
  is_active   Boolean   @default(true) @map("is_active")
  last_used   DateTime? @map("last_used") @db.Timestamp(6)
  created_at  DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  expires_at  DateTime? @map("expires_at") @db.Timestamp(6)
  tenant      Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id], map: "idx_api_keys_tenant")
  @@index([api_key], map: "idx_api_keys_key")
  @@map("api_keys")
}

model Inventory {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  category    String    @db.VarChar(100)
  unit        String    @db.VarChar(50)
  currentStock Decimal  @default(0) @map("current_stock") @db.Decimal(12, 2)
  alert       Boolean   @default(false)
  stockAlert  Decimal   @default(0) @map("stock_alert") @db.Decimal(12, 2)
  trackCost   Boolean   @default(false) @map("track_cost")
  costAmount  Decimal   @default(0) @map("cost_amount") @db.Decimal(12, 2)
  outletId    Int?      @map("outlet_id")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([outletId], map: "idx_inventory_outlet")
  @@index([category], map: "idx_inventory_category")
  @@map("inventory")
}

model SalesTransaction {
  id             Int       @id @default(autoincrement())
  outlet         String    @db.VarChar(255)
  receiptNumber  String    @map("receipt_number") @db.VarChar(100)
  date           DateTime  @db.Timestamp(6)
  time           String    @db.VarChar(20)
  category       String    @db.VarChar(100)
  brand          String    @default("Unbranded") @db.VarChar(100)
  itemName       String    @map("item_name") @db.VarChar(255)
  variant        String?   @db.VarChar(100)
  sku            String?   @db.VarChar(100)
  quantity       Int
  grossSales     Decimal   @map("gross_sales") @db.Decimal(12, 2)
  discounts      Decimal   @default(0) @db.Decimal(12, 2)
  refunds        Decimal   @default(0) @db.Decimal(12, 2)
  netSales       Decimal   @map("net_sales") @db.Decimal(12, 2)
  tax            Decimal   @default(0) @db.Decimal(12, 2)
  gratuity       Decimal   @default(0) @db.Decimal(12, 2)
  salesType      String    @map("sales_type") @db.VarChar(50)
  paymentMethod  String    @map("payment_method") @db.VarChar(50)
  servedBy       String    @map("served_by") @db.VarChar(255)
  collectedBy    String    @map("collected_by") @db.VarChar(255)
  outletId       Int?      @map("outlet_id")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([outletId], map: "idx_sales_outlet")
  @@index([date], map: "idx_sales_date")
  @@index([receiptNumber], map: "idx_sales_receipt")
  @@index([category], map: "idx_sales_category")
  @@map("sales_transactions")
}
