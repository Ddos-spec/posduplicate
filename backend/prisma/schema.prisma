// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  permissions Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]

  @@map("roles")
}

model Tenant {
  id                    Int       @id @default(autoincrement())
  businessName          String    @map("business_name") @db.VarChar(255)
  ownerName             String    @map("owner_name") @db.VarChar(255)
  email                 String    @unique @db.VarChar(255)
  phone                 String?   @db.VarChar(50)
  address               String?   @db.Text
  subscriptionPlan      String    @default("basic") @map("subscription_plan") @db.VarChar(50)
  subscriptionStatus    String    @default("trial") @map("subscription_status") @db.VarChar(50)
  subscriptionStartsAt  DateTime? @map("subscription_starts_at")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  maxOutlets            Int       @default(1) @map("max_outlets")
  maxUsers              Int       @default(5) @map("max_users")
  billingEmail          String?   @map("billing_email") @db.VarChar(255)
  paymentMethod         String?   @map("payment_method") @db.VarChar(50)
  lastPaymentAt         DateTime? @map("last_payment_at")
  nextBillingDate       DateTime? @map("next_billing_date") @db.Date
  settings              Json      @default("{}")
  features              Json      @default("{}")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  outlets               Outlet[]
  users                 User[]

  @@index([email])
  @@index([subscriptionStatus], map: "idx_tenants_status")
  @@index([isActive], map: "idx_tenants_active")
  @@map("tenants")
}

model Outlet {
  id        Int      @id @default(autoincrement())
  tenantId  Int?     @map("tenant_id")
  name      String   @db.VarChar(255)
  address   String?  @db.Text
  phone     String?  @db.VarChar(50)
  email     String?  @db.VarChar(255)
  npwp      String?  @db.VarChar(50)
  settings  Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users        User[]
  categories   Category[]
  items        Item[]
  ingredients  Ingredient[]
  suppliers    Supplier[]
  transactions Transaction[]
  tables       Table[]

  @@index([tenantId], map: "idx_outlets_tenant")
  @@map("outlets")
}

model User {
  id           Int       @id @default(autoincrement())
  tenantId     Int?      @map("tenant_id")
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(255)
  roleId       Int       @map("role_id")
  outletId     Int?      @map("outlet_id")
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role         Role      @relation(fields: [roleId], references: [id])
  outlet       Outlet?   @relation(fields: [outletId], references: [id])
  transactions Transaction[]
  employees    Employee[]

  @@index([email])
  @@index([tenantId], map: "idx_users_tenant")
  @@index([outletId])
  @@map("users")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  type      String   @default("item") @db.VarChar(50)
  outletId  Int?     @map("outlet_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outlet      Outlet?       @relation(fields: [outletId], references: [id])
  items       Item[]
  ingredients Ingredient[]

  @@map("categories")
}

model Item {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  categoryId  Int?     @map("category_id")
  price       Decimal  @default(0) @db.Decimal(12, 2)
  cost        Decimal? @default(0) @db.Decimal(12, 2)
  image       String?  @db.VarChar(500)
  description String?  @db.Text
  sku         String?  @db.VarChar(100)
  stock       Decimal  @default(0) @db.Decimal(12, 2)
  trackStock  Boolean  @default(false) @map("track_stock")
  minStock    Decimal  @default(0) @map("min_stock") @db.Decimal(12, 2)
  outletId    Int?     @map("outlet_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category           Category?           @relation(fields: [categoryId], references: [id])
  outlet             Outlet?             @relation(fields: [outletId], references: [id])
  variants           Variant[]
  modifiers          ItemModifier[]
  recipes            Recipe[]
  transactionItems   TransactionItem[]

  @@index([categoryId])
  @@index([outletId])
  @@index([isActive])
  @@map("items")
}

model Variant {
  id          Int      @id @default(autoincrement())
  itemId      Int      @map("item_id")
  name        String   @db.VarChar(255)
  priceAdjust Decimal  @default(0) @map("price_adjust") @db.Decimal(12, 2)
  sku         String?  @db.VarChar(100)
  stock       Decimal  @default(0) @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  item             Item              @relation(fields: [itemId], references: [id], onDelete: Cascade)
  transactionItems TransactionItem[]

  @@map("variants")
}

model Modifier {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  price     Decimal  @default(0) @db.Decimal(12, 2)
  outletId  Int?     @map("outlet_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items                ItemModifier[]
  transactionModifiers TransactionModifier[]

  @@map("modifiers")
}

model ItemModifier {
  itemId     Int @map("item_id")
  modifierId Int @map("modifier_id")

  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  modifier Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  @@id([itemId, modifierId])
  @@map("item_modifiers")
}

model Ingredient {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  categoryId  Int?     @map("category_id")
  unit        String   @db.VarChar(50)
  stock       Decimal  @default(0) @db.Decimal(12, 2)
  minStock    Decimal  @default(0) @map("min_stock") @db.Decimal(12, 2)
  costPerUnit Decimal  @default(0) @map("cost_per_unit") @db.Decimal(12, 2)
  outletId    Int?     @map("outlet_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category           Category?            @relation(fields: [categoryId], references: [id])
  outlet             Outlet?              @relation(fields: [outletId], references: [id])
  recipeIngredients  RecipeIngredient[]
  inventoryMovements InventoryMovement[]

  @@index([outletId])
  @@map("ingredients")
}

model Recipe {
  id          Int      @id @default(autoincrement())
  itemId      Int      @map("item_id")
  yieldQty    Decimal  @default(1) @map("yield_qty") @db.Decimal(12, 2)
  yieldUnit   String?  @map("yield_unit") @db.VarChar(50)
  costPerUnit Decimal  @default(0) @map("cost_per_unit") @db.Decimal(12, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  item               Item               @relation(fields: [itemId], references: [id], onDelete: Cascade)
  recipeIngredients  RecipeIngredient[]

  @@map("recipes")
}

model RecipeIngredient {
  id           Int     @id @default(autoincrement())
  recipeId     Int     @map("recipe_id")
  ingredientId Int     @map("ingredient_id")
  quantity     Decimal @db.Decimal(12, 2)
  unit         String  @db.VarChar(50)

  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  @@map("recipe_ingredients")
}

model Supplier {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(255)
  contactPerson String?  @map("contact_person") @db.VarChar(255)
  phone         String?  @db.VarChar(50)
  email         String?  @db.VarChar(255)
  address       String?  @db.Text
  outletId      Int?     @map("outlet_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  outlet         Outlet?         @relation(fields: [outletId], references: [id])
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model PurchaseOrder {
  id         Int      @id @default(autoincrement())
  poNumber   String   @unique @map("po_number") @db.VarChar(100)
  supplierId Int      @map("supplier_id")
  status     String   @default("pending") @db.VarChar(50)
  subtotal   Decimal  @default(0) @db.Decimal(12, 2)
  tax        Decimal  @default(0) @db.Decimal(12, 2)
  total      Decimal  @default(0) @db.Decimal(12, 2)
  notes      String?  @db.Text
  outletId   Int?     @map("outlet_id")
  createdBy  Int?     @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  supplier           Supplier             @relation(fields: [supplierId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id           Int     @id @default(autoincrement())
  poId         Int     @map("po_id")
  ingredientId Int     @map("ingredient_id")
  quantity     Decimal @db.Decimal(12, 2)
  unitPrice    Decimal @map("unit_price") @db.Decimal(12, 2)
  subtotal     Decimal @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

model InventoryMovement {
  id             Int      @id @default(autoincrement())
  type           String   @db.VarChar(50)
  ingredientId   Int      @map("ingredient_id")
  quantity       Decimal  @db.Decimal(12, 2)
  fromOutletId   Int?     @map("from_outlet_id")
  toOutletId     Int?     @map("to_outlet_id")
  referenceId    Int?     @map("reference_id")
  referenceType  String?  @map("reference_type") @db.VarChar(50)
  notes          String?  @db.Text
  createdBy      Int?     @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")

  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  @@index([type])
  @@index([ingredientId])
  @@map("inventory_movements")
}

model Table {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  capacity  Int      @default(4)
  status    String   @default("available") @db.VarChar(50)
  outletId  Int?     @map("outlet_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outlet       Outlet?       @relation(fields: [outletId], references: [id])
  transactions Transaction[]

  @@map("tables")
}

model Transaction {
  id                Int       @id @default(autoincrement())
  transactionNumber String    @unique @map("transaction_number") @db.VarChar(100)
  orderType         String    @map("order_type") @db.VarChar(50)
  tableId           Int?      @map("table_id")
  customerName      String?   @map("customer_name") @db.VarChar(255)
  customerPhone     String?   @map("customer_phone") @db.VarChar(50)
  subtotal          Decimal   @default(0) @db.Decimal(12, 2)
  discountAmount    Decimal   @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxAmount         Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  serviceCharge     Decimal   @default(0) @map("service_charge") @db.Decimal(12, 2)
  total             Decimal   @default(0) @db.Decimal(12, 2)
  status            String    @default("pending") @db.VarChar(50)
  notes             String?   @db.Text
  outletId          Int?      @map("outlet_id")
  cashierId         Int?      @map("cashier_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  completedAt       DateTime? @map("completed_at")

  outlet           Outlet?           @relation(fields: [outletId], references: [id])
  table            Table?            @relation(fields: [tableId], references: [id])
  cashier          User?             @relation(fields: [cashierId], references: [id])
  transactionItems TransactionItem[]
  payments         Payment[]

  @@index([transactionNumber])
  @@index([outletId])
  @@index([cashierId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model TransactionItem {
  id             Int     @id @default(autoincrement())
  transactionId  Int     @map("transaction_id")
  itemId         Int     @map("item_id")
  variantId      Int?    @map("variant_id")
  itemName       String  @map("item_name") @db.VarChar(255)
  quantity       Decimal @db.Decimal(12, 2)
  unitPrice      Decimal @map("unit_price") @db.Decimal(12, 2)
  subtotal       Decimal @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  notes          String? @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  transaction          Transaction           @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  item                 Item                  @relation(fields: [itemId], references: [id])
  variant              Variant?              @relation(fields: [variantId], references: [id])
  transactionModifiers TransactionModifier[]

  @@index([transactionId])
  @@map("transaction_items")
}

model TransactionModifier {
  id                Int     @id @default(autoincrement())
  transactionItemId Int     @map("transaction_item_id")
  modifierId        Int     @map("modifier_id")
  modifierName      String  @map("modifier_name") @db.VarChar(255)
  price             Decimal @db.Decimal(12, 2)

  transactionItem TransactionItem @relation(fields: [transactionItemId], references: [id], onDelete: Cascade)
  modifier        Modifier        @relation(fields: [modifierId], references: [id])

  @@map("transaction_modifiers")
}

model Payment {
  id                Int      @id @default(autoincrement())
  transactionId     Int      @map("transaction_id")
  method            String   @db.VarChar(50)
  amount            Decimal  @db.Decimal(12, 2)
  changeAmount      Decimal  @default(0) @map("change_amount") @db.Decimal(12, 2)
  referenceNumber   String?  @map("reference_number") @db.VarChar(255)
  status            String   @default("completed") @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model HeldOrder {
  id        Int      @id @default(autoincrement())
  orderData Json     @map("order_data")
  cashierId Int?     @map("cashier_id")
  outletId  Int?     @map("outlet_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  @@map("held_orders")
}

model Customer {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  phone       String?   @db.VarChar(50)
  email       String?   @db.VarChar(255)
  address     String?   @db.Text
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  outletId    Int?      @map("outlet_id")
  totalSpent  Decimal   @default(0) @map("total_spent") @db.Decimal(12, 2)
  totalVisits Int       @default(0) @map("total_visits")
  lastVisit   DateTime? @map("last_visit")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  loyaltyPoints         LoyaltyPoints[]
  loyaltyTransactions   LoyaltyTransaction[]
  feedback              Feedback[]

  @@index([phone])
  @@index([email])
  @@index([outletId])
  @@map("customers")
}

model LoyaltyTier {
  id                 Int     @id @default(autoincrement())
  name               String  @db.VarChar(100)
  minPoints          Int     @default(0) @map("min_points")
  discountPercentage Decimal @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  benefits           Json    @default("{}")
  outletId           Int?    @map("outlet_id")
  createdAt          DateTime @default(now()) @map("created_at")

  loyaltyPoints LoyaltyPoints[]

  @@map("loyalty_tiers")
}

model LoyaltyPoints {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  points     Int      @default(0)
  tierId     Int?     @map("tier_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  customer Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tier     LoyaltyTier? @relation(fields: [tierId], references: [id])

  @@map("loyalty_points")
}

model LoyaltyTransaction {
  id             Int      @id @default(autoincrement())
  customerId     Int      @map("customer_id")
  transactionId  Int?     @map("transaction_id")
  pointsEarned   Int      @default(0) @map("points_earned")
  pointsRedeemed Int      @default(0) @map("points_redeemed")
  createdAt      DateTime @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id])

  @@map("loyalty_transactions")
}

model Feedback {
  id           Int       @id @default(autoincrement())
  customerId   Int?      @map("customer_id")
  transactionId Int?     @map("transaction_id")
  rating       Int
  comment      String?   @db.Text
  response     String?   @db.Text
  respondedBy  Int?      @map("responded_by")
  respondedAt  DateTime? @map("responded_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  customer Customer? @relation(fields: [customerId], references: [id])

  @@map("feedback")
}

model Employee {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  outletId     Int      @map("outlet_id")
  employeeCode String?  @map("employee_code") @db.VarChar(50)
  pinCode      String?  @map("pin_code") @db.VarChar(6)
  position     String?  @db.VarChar(100)
  salary       Decimal? @db.Decimal(12, 2)
  isActive     Boolean  @default(true) @map("is_active")
  hiredAt      DateTime? @map("hired_at") @db.Date
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  shifts Shift[]

  @@map("employees")
}

model Shift {
  id           Int       @id @default(autoincrement())
  employeeId   Int       @map("employee_id")
  outletId     Int?      @map("outlet_id")
  startTime    DateTime  @map("start_time")
  endTime      DateTime? @map("end_time")
  expectedCash Decimal   @default(0) @map("expected_cash") @db.Decimal(12, 2)
  actualCash   Decimal   @default(0) @map("actual_cash") @db.Decimal(12, 2)
  difference   Decimal   @default(0) @db.Decimal(12, 2)
  notes        String?   @db.Text
  status       String    @default("active") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@map("shifts")
}

model PromoCampaign {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(255)
  type          String   @db.VarChar(50)
  value         Decimal  @db.Decimal(12, 2)
  minPurchase   Decimal  @default(0) @map("min_purchase") @db.Decimal(12, 2)
  applicableTo  Json     @default("{}") @map("applicable_to")
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")
  usageLimit    Int?     @map("usage_limit")
  usageCount    Int      @default(0) @map("usage_count")
  outletId      Int?     @map("outlet_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("promo_campaigns")
}

model Discount {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(255)
  type          String   @db.VarChar(50)
  value         Decimal  @db.Decimal(12, 2)
  applicableTo  String   @default("all") @map("applicable_to") @db.VarChar(50)
  applicableIds Json     @default("[]") @map("applicable_ids")
  outletId      Int?     @map("outlet_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("discounts")
}

model Tax {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(100)
  rate          Decimal  @db.Decimal(5, 2)
  type          String   @default("percentage") @db.VarChar(50)
  applicableTo  String   @default("all") @map("applicable_to") @db.VarChar(50)
  outletId      Int?     @map("outlet_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("taxes")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(255)
  value     String?  @db.Text
  type      String   @default("string") @db.VarChar(50)
  outletId  Int?     @map("outlet_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(100)
  entityId   Int?     @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address") @db.VarChar(50)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
