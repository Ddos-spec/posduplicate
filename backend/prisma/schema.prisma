generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(50)
  permissions Json?     @default("{}")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  users       User[]

  @@map("roles")
}

model Tenant {
  id                    Int       @id @default(autoincrement())
  businessName          String    @map("business_name") @db.VarChar(255)
  ownerName             String    @map("owner_name") @db.VarChar(255)
  email                 String    @unique @db.VarChar(255)
  phone                 String?   @db.VarChar(50)
  address               String?
  subscriptionPlan      String?   @default("basic") @map("subscription_plan") @db.VarChar(50)
  subscriptionStatus    String?   @default("trial") @map("subscription_status") @db.VarChar(50)
  subscriptionStartsAt  DateTime? @map("subscription_starts_at") @db.Timestamp(6)
  subscriptionExpiresAt DateTime? @map("subscription_expires_at") @db.Timestamp(6)
  maxOutlets            Int?      @default(1) @map("max_outlets")
  maxUsers              Int?      @default(5) @map("max_users")
  billingEmail          String?   @map("billing_email") @db.VarChar(255)
  paymentMethod         String?   @map("payment_method") @db.VarChar(50)
  lastPaymentAt         DateTime? @map("last_payment_at") @db.Timestamp(6)
  nextBillingDate       DateTime? @map("next_billing_date") @db.Date
  settings              Json?     @default("{}")
  features              Json?     @default("{}")
  isActive              Boolean?  @default(true) @map("is_active")
  createdAt             DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt             DateTime? @map("deleted_at") @db.Timestamp(6)
  googleSheetId         String?   @map("google_sheet_id") @db.VarChar(255)
  outlets               Outlet[]
  users                 User[]

  @@index([subscriptionStatus], map: "idx_tenants_status")
  @@index([isActive], map: "idx_tenants_active")
  @@index([email], map: "idx_tenants_email")
  @@map("tenants")
}

model Outlet {
  id           Int           @id @default(autoincrement())
  tenantId     Int?          @map("tenant_id")
  name         String        @db.VarChar(255)
  address      String?
  phone        String?       @db.VarChar(50)
  email        String?       @db.VarChar(255)
  npwp         String?       @db.VarChar(50)
  settings     Json?         @default("{}")
  isActive     Boolean?      @default(true) @map("is_active")
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  categories   categories[]
  customers    customers[]
  employees    employees[]
  ingredients  ingredients[]
  items        items[]
  modifiers    modifiers[]
  tenants      Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  promotions   promotions[]
  tables       tables[]
  transactions Transaction[]
  users        User[]

  @@index([tenantId], map: "idx_outlets_tenant")
  @@map("outlets")
}

model User {
  id           Int           @id @default(autoincrement())
  tenantId     Int?          @map("tenant_id")
  email        String        @unique @db.VarChar(255)
  passwordHash String        @map("password_hash") @db.VarChar(255)
  name         String        @db.VarChar(255)
  roleId       Int           @map("role_id")
  outletId     Int?          @map("outlet_id")
  isActive     Boolean?      @default(true) @map("is_active")
  lastLogin    DateTime?     @map("last_login") @db.Timestamp(6)
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  employees    employees[]
  transactions Transaction[]
  outlets      Outlet?       @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles        Role          @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants      Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId], map: "idx_users_tenant")
  @@index([email], map: "idx_users_email")
  @@index([outletId], map: "idx_users_outlet")
  @@map("users")
}

model Transaction {
  id                 Int               @id @default(autoincrement())
  transaction_number String            @unique @db.VarChar(100)
  order_type         String            @db.VarChar(50)
  table_id           Int?
  customer_name      String?           @db.VarChar(255)
  customer_phone     String?           @db.VarChar(50)
  subtotal           Decimal?          @default(0) @db.Decimal(12, 2)
  discountAmount     Decimal?          @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxAmount          Decimal?          @default(0) @map("tax_amount") @db.Decimal(12, 2)
  service_charge     Decimal?          @default(0) @db.Decimal(12, 2)
  total              Decimal?          @default(0) @db.Decimal(12, 2)
  status             String?           @default("pending") @db.VarChar(50)
  notes              String?
  outletId           Int?              @map("outlet_id")
  cashier_id         Int?
  createdAt          DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updated_at         DateTime?         @default(now()) @db.Timestamp(6)
  completed_at       DateTime?         @db.Timestamp(6)
  promotion_id       Int?
  discount_usage     discount_usage[]
  payments           payments[]
  transaction_items  TransactionItem[]
  users              User?             @relation(fields: [cashier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets            Outlet?           @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  promotions         promotions?       @relation(fields: [promotion_id], references: [id], onUpdate: NoAction)
  tables             tables?           @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([outletId], map: "idx_transactions_outlet")
  @@index([cashier_id], map: "idx_transactions_cashier")
  @@index([createdAt], map: "idx_transactions_created")
  @@index([transaction_number], map: "idx_transactions_number")
  @@index([status], map: "idx_transactions_status")
  @@map("transactions")
}

model TransactionItem {
  id                    Int                     @id @default(autoincrement())
  transactionId         Int                     @map("transaction_id")
  item_id               Int
  variant_id            Int?
  item_name             String                  @db.VarChar(255)
  quantity              Decimal                 @db.Decimal(12, 2)
  unit_price            Decimal                 @db.Decimal(12, 2)
  subtotal              Decimal                 @db.Decimal(12, 2)
  discount_amount       Decimal?                @default(0) @db.Decimal(12, 2)
  notes                 String?
  createdAt             DateTime?               @default(now()) @map("created_at") @db.Timestamp(6)
  items                 items                   @relation(fields: [item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions          Transaction             @relation(fields: [transactionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  variants              variants?               @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_modifiers transaction_modifiers[]

  @@index([transactionId], map: "idx_transaction_items_transaction")
  @@map("transaction_items")
}

model categories {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(255)
  type        String?       @default("item") @db.VarChar(50)
  outletId    Int?          @map("outlet_id")
  isActive    Boolean?      @default(true) @map("is_active")
  createdAt   DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime?     @default(now()) @map("updated_at") @db.Timestamp(6)
  outlets     Outlet?       @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ingredients ingredients[]
  items       items[]
}

model recipes {
  id            Int         @id @default(autoincrement())
  item_id       Int
  ingredient_id Int
  quantity      Decimal     @db.Decimal(12, 2)
  unit          String?     @db.VarChar(50)
  items         items       @relation(fields: [item_id], references: [id], onDelete: Cascade)
  ingredients   ingredients @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)

  @@map("recipes")
}

model customers {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(255)
  phone         String?   @db.VarChar(50)
  email         String?   @db.VarChar(255)
  address       String?
  date_of_birth DateTime? @db.Date
  outlet_id     Int?
  total_spent   Decimal?  @default(0) @db.Decimal(12, 2)
  total_visits  Int?      @default(0)
  last_visit    DateTime? @db.Timestamp(6)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  outlets       Outlet?   @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email], map: "idx_customers_email")
  @@index([outlet_id], map: "idx_customers_outlet")
  @@index([phone], map: "idx_customers_phone")
}

model employees {
  id            Int       @id @default(autoincrement())
  user_id       Int
  outlet_id     Int
  employee_code String?   @db.VarChar(50)
  pin_code      String?   @db.VarChar(6)
  position      String?   @db.VarChar(100)
  salary        Decimal?  @db.Decimal(12, 2)
  is_active     Boolean?  @default(true)
  hired_at      DateTime? @db.Date
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  outlets       Outlet    @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users         User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model ingredients {
  id            Int         @id @default(autoincrement())
  name          String      @db.VarChar(255)
  category_id   Int?
  unit          String      @db.VarChar(50)
  stock         Decimal?    @default(0) @db.Decimal(12, 2)
  min_stock     Decimal?    @default(0) @db.Decimal(12, 2)
  cost_per_unit Decimal?    @default(0) @db.Decimal(12, 2)
  outlet_id     Int?
  is_active     Boolean?    @default(true)
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  updated_at    DateTime?   @default(now()) @db.Timestamp(6)
  categories    categories? @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets       Outlet?     @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipes       recipes[]

  @@index([outlet_id], map: "idx_ingredients_outlet")
}

model item_modifiers {
  item_id     Int
  modifier_id Int
  items       items     @relation(fields: [item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifiers   modifiers @relation(fields: [modifier_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([item_id, modifier_id])
}

model items {
  id                Int               @id @default(autoincrement())
  name              String            @db.VarChar(255)
  categoryId        Int?              @map("category_id")
  price             Decimal           @default(0) @db.Decimal(12, 2)
  cost              Decimal?          @default(0) @db.Decimal(12, 2)
  image             String?           @db.VarChar(500)
  description       String?
  sku               String?           @db.VarChar(100)
  stock             Decimal?          @default(0) @db.Decimal(12, 2)
  trackStock        Boolean?          @default(false) @map("track_stock")
  minStock          Decimal?          @default(0) @map("min_stock") @db.Decimal(12, 2)
  outletId          Int?              @map("outlet_id")
  isActive          Boolean?          @default(true) @map("is_active")
  createdAt         DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime?         @default(now()) @map("updated_at") @db.Timestamp(6)
  item_modifiers    item_modifiers[]
  categories        categories?       @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  outlets           Outlet?           @relation(fields: [outletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_items TransactionItem[]
  variants          variants[]
  recipes           recipes[]

  @@index([isActive], map: "idx_items_active")
  @@index([categoryId], map: "idx_items_category")
  @@index([outletId], map: "idx_items_outlet")
}

model modifiers {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @db.VarChar(255)
  price                 Decimal?                @default(0) @db.Decimal(12, 2)
  outlet_id             Int?
  is_active             Boolean?                @default(true)
  created_at            DateTime?               @default(now()) @db.Timestamp(6)
  updated_at            DateTime?               @default(now()) @db.Timestamp(6)
  item_modifiers        item_modifiers[]
  outlets               Outlet?                 @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_modifiers transaction_modifiers[]
}

model payments {
  id               Int         @id @default(autoincrement())
  transaction_id   Int
  method           String      @db.VarChar(50)
  amount           Decimal     @db.Decimal(12, 2)
  change_amount    Decimal?    @default(0) @db.Decimal(12, 2)
  reference_number String?     @db.VarChar(255)
  status           String?     @default("completed") @db.VarChar(50)
  created_at       DateTime?   @default(now()) @db.Timestamp(6)
  transactions     Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model tables {
  id           Int           @id @default(autoincrement())
  name         String        @db.VarChar(100)
  capacity     Int?          @default(4)
  status       String?       @default("available") @db.VarChar(50)
  outlet_id    Int?
  is_active    Boolean?      @default(true)
  created_at   DateTime?     @default(now()) @db.Timestamp(6)
  updated_at   DateTime?     @default(now()) @db.Timestamp(6)
  outlets      Outlet?       @relation(fields: [outlet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions Transaction[]
}

model transaction_modifiers {
  id                  Int             @id @default(autoincrement())
  transaction_item_id Int
  modifier_id         Int
  modifier_name       String          @db.VarChar(255)
  price               Decimal         @db.Decimal(12, 2)
  modifiers           modifiers       @relation(fields: [modifier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transaction_items   TransactionItem @relation(fields: [transaction_item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model variants {
  id                Int               @id @default(autoincrement())
  item_id           Int
  name              String            @db.VarChar(255)
  price_adjust      Decimal?          @default(0) @db.Decimal(12, 2)
  sku               String?           @db.VarChar(100)
  stock             Decimal?          @default(0) @db.Decimal(12, 2)
  is_active         Boolean?          @default(true)
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  transaction_items TransactionItem[]
  items             items             @relation(fields: [item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model discount_usage {
  id              Int          @id @default(autoincrement())
  promotion_id    Int?
  transaction_id  Int?
  discount_amount Decimal      @db.Decimal(12, 2)
  created_at      DateTime?    @default(now()) @db.Timestamp(6)
  promotions      promotions?  @relation(fields: [promotion_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transactions    Transaction? @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([promotion_id], map: "idx_discount_usage_promotion")
  @@index([transaction_id], map: "idx_discount_usage_transaction")
}

model promotions {
  id             Int              @id @default(autoincrement())
  outlet_id      Int?
  name           String           @db.VarChar(255)
  description    String?
  discount_type  String           @db.VarChar(50)
  discount_value Decimal          @db.Decimal(12, 2)
  min_purchase   Decimal?         @default(0) @db.Decimal(12, 2)
  max_discount   Decimal?         @db.Decimal(12, 2)
  applicable_to  String?          @default("all") @db.VarChar(50)
  applicable_ids Json?            @db.Json
  start_date     DateTime?        @db.Timestamp(6)
  end_date       DateTime?        @db.Timestamp(6)
  usage_limit    Int?
  usage_count    Int?             @default(0)
  is_active      Boolean?         @default(true)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  updated_at     DateTime?        @default(now()) @db.Timestamp(6)
  discount_usage discount_usage[]
  outlets        Outlet?          @relation(fields: [outlet_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transactions   Transaction[]

  @@index([is_active], map: "idx_promotions_active")
  @@index([start_date, end_date], map: "idx_promotions_dates")
  @@index([outlet_id], map: "idx_promotions_outlet")
}
